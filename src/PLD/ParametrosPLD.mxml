<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" height="100%" width="100%" xmlns:forms="forms.*" 
	xmlns:Data="Data.*" xmlns:Administracion="Administracion.*" creationPolicy="all" creationComplete="initApp()">

	<mx:Script>
		<![CDATA[
		import Data.Globales;
		import Data.Utils;
		import mx.collections.ArrayCollection;
		import mx.controls.Alert;
		import mx.core.Application;
		import mx.effects.*;
		import mx.events.CloseEvent;
		import mx.events.EffectEvent;
		import mx.managers.PopUpManager;
		import mx.rpc.events.ResultEvent;
		import mx.rpc.soap.WebService;
		import mx.utils.ArrayUtil;
		
		private var _xmlInfo:XML = new XML();
		private var _xmlMoneda:XML =  new XML();
		
		public var estObj:ArrayCollection = new ArrayCollection();
		public var infoObj:ArrayCollection = new ArrayCollection();
		public var monedaObj:ArrayCollection = new ArrayCollection();
		public var monedaExtObj:ArrayCollection = new ArrayCollection();

		public var wsMS:WebService;	
		public var tipoAccion:int;
		public var titulo:String;
		public var texto:String;
		public var control:Number;
		public var tipoTransac:int;
		private var du:Utils;
		private var global:Globales;
		
		public function consultaParametros():void{
	 	    var wsCatPLD:WebService = new WebService;
	 	    
	 	    du.initWsCatPLD(wsCatPLD);
			du.sCursor();
					
			du.ejecutaWsMethod(wsCatPLD,function(evt:ResultEvent):void {											
				_xmlInfo = new XML(evt.result.toString());
				
				du.rCursor();
				du.closeWs(wsCatPLD);
				
				if(_xmlInfo.elements().length() > 0){
					tipoTransac = 2;
					txtNumParcial.text = _xmlInfo.Table[0].NUM_PARC;
					txtMontoDivi.text =	global.formatearDecimal(_xmlInfo.Table[0].MONTO_REF);
					txtNumTransac.text = _xmlInfo.Table[0].NUM_TRANS;
					txtEmailCump.text =	_xmlInfo.Table[0].CORREO_OFICIAL;
					var i:int;
					var codigo:String;
					var moneda:String;					
					
					for(i = 0; i < (cboMoneda.dataProvider as ArrayCollection).length; i++){
						codigo = (cboMoneda.dataProvider as ArrayCollection)[i].id ;
						moneda = _xmlInfo.Table[0].MONEDA; 
						if(codigo == moneda){
							 cboMoneda.selectedIndex = i;
						}						 
					}
					for(i = 0; i < (cboMonedaExt.dataProvider as ArrayCollection).length; i++){
						codigo = (cboMonedaExt.dataProvider as ArrayCollection)[i].id ;
						moneda = _xmlInfo.Table[0].MONEDA_EXT; 
						if(codigo == moneda){
							 cboMonedaExt.selectedIndex = i;
						}						 
					}
				} 	
				else
					tipoTransac = 1;			
			});
			wsCatPLD.getInfoRegistroPLD.send(3);
	 	}
		
		private function guardarParametros():void{
			if (validaForm()){
		     	initConexion();
				du.sCursor();
				var moneda:String = cboMoneda.selectedItem.id;
				var moneda_ext:String = cboMonedaExt.selectedItem.id;
				global.bloquear();
				wsMS.addEventListener(ResultEvent.RESULT, setAccionParametrosPLD);
				wsMS.setAccionParametrosPLD.send(global.obtenerUsuario(), tipoTransac, txtNumParcial.text, global.formatearNumerico(txtMontoDivi.text), 
										         txtNumTransac.text, moneda, txtEmailCump.text, moneda_ext);			    								
			}		    									
		}
		
		private function formateaMoneda():void {
			var cont:int = _xmlMoneda.elements().length();
			var oItem:Object;
			var item:Array = new Array();
			var itemExt:Array = new Array;
			
			oItem = new Object();
			oItem.id = "";	
			oItem.nombre = "--Seleccionar--";
			item.push(oItem);
			itemExt.push(oItem);
			
			for (var i:int = 0; i < cont; i++){
				if(_xmlMoneda.Table[i].TIPO == 'N'){
					oItem = new Object();
					oItem.id = _xmlMoneda.Table[i].CODIGO;	
					oItem.nombre = _xmlMoneda.Table[i].NOMBRE;
					item.push(oItem);
				}
				else if(_xmlMoneda.Table[i].TIPO == 'E'){
					oItem = new Object();
					oItem.id = _xmlMoneda.Table[i].CODIGO;	
					oItem.nombre = _xmlMoneda.Table[i].NOMBRE;
					itemExt.push(oItem);
				}
			}
			monedaObj = new ArrayCollection(item);
			monedaExtObj = new ArrayCollection(itemExt);
		}
		
		public function initApp():void{
			du = new Utils();
			global = new Globales();
			titulo = "Parámetros PLD";
			lblTitulo.text = titulo.toUpperCase();
			llenaCombosMoneda();
		}
		
	 	public function llenaCombosMoneda():void{
	 	    var wsCat:WebService = new WebService;
	 	    
	 	    du.initWsCat(wsCat);
			du.sCursor();
					
			du.ejecutaWsMethod(wsCat,function(evt:ResultEvent):void {											
				_xmlMoneda = new XML(evt.result.toString());
				
				du.rCursor();
				du.closeWs(wsCat);
				
				if (_xmlMoneda.elements().length() > 0){
					formateaMoneda();
					cboMoneda.dataProvider = monedaObj;
					cboMonedaExt.dataProvider = monedaExtObj;
					cboMoneda.selectedIndex = 0;
					cboMonedaExt.selectedIndex = 0;									
				} 	
				consultaParametros();				
			});
			wsCat.getCatalogoGral.send(14);
	 	}
	 	
		public function initConexion():void{				
			wsMS = new WebService();			
			wsMS.wsdl = Application.application.wsStr.wsdlServPLD.toString();
			wsMS.loadWSDL();
		}	
		
		private function limpiar():void{
			txtNumParcial.text = "";
			txtMontoDivi.text = "";
			cboMoneda.selectedIndex = 0;
			cboMonedaExt.selectedIndex = 0;
			txtNumTransac.text="";
		 	txtEmailCump.text="";
		}
		
		private function setAccionParametrosPLD(event:ResultEvent):void{
			wsMS.disconnect();
			du.rCursor();
			global.desbloquear();
			wsMS.removeEventListener(ResultEvent.RESULT, setAccionParametrosPLD);
			wsMS = null;
			var res:String = event.result.toString();
			if (res.substr(0,1) == "1"){				 
				du.mostrarMensaje("Proceso finalizado exitosamente.",titulo,4,null,null,global.iInfo);				 		  
			}	
			else{
 				du.mostrarMensaje(res.substr(2,res.length -1),titulo,4,null,null,global.iError);	
			 }	
		}
		
		private function validaForm():Boolean{
			if(txtNumParcial.text == ""){
				du.mostrarMensaje("El Número de Parcialidades no debe estar vacio.",titulo,4,null,null,global.iAlert);	
				return false;
			}
			else if(txtMontoDivi.text == ""){
				du.mostrarMensaje("El Monto Divisa no debe estar vacio.",titulo,4,null,null,global.iAlert);
				return false;
			}
			else if(cboMoneda.selectedIndex == 0 ){
				du.mostrarMensaje("Seleccione un tipo de Moneda.",titulo,4,null,null,global.iAlert);
				return false;
			}
			else if(cboMonedaExt.selectedIndex == 0){
				du.mostrarMensaje("Seleccione un tipo de Moneda Extranjera.",titulo,4,null,null,global.iAlert);
				return false;
			}
			else if(txtNumTransac.text == ""){
				du.mostrarMensaje("El Número de Transacciones no debe estar vacio.",titulo,4,null,null,global.iAlert);
				return false;
			}
		 	else if(txtEmailCump.text == ""){
				du.mostrarMensaje("El Correo Oficial de Cumplimiento no debe estar vacio.",titulo,4,null,null,global.iAlert);
				return false;
			} 	
		 	return true;
		}
				
		]]>
	</mx:Script>
	<mx:Canvas width="420" height="285" backgroundColor="#ffffff" backgroundAlpha="1.0" id="canvas1">
		<mx:Label id="lblTitulo" x="21" y="10" width="247" fontSize="12" fontWeight="bold" fontStyle="italic"/>
		<mx:Canvas x="21" y="39" width="380.5" height="205" styleName="canvasMod">
			<mx:Label id="lblCodigo" x="18" y="12" text="Número Parcialidades:"/>
			<mx:TextInput id="txtNumParcial" tabIndex="1" x="138" y="10" width="35"/>
			<mx:Label id="lblMontoDivi" x="61" y="139" text="Monto Divisa:"/>
			<mx:TextInput id="txtMontoDivi" tabIndex="5" x="138" y="137" width="96" restrict="0-9;.;," maxChars="18" focusOut="{global.formatearMonto(event)}"/>
			<mx:Label id="lblMoneda" x="84" y="77" text="Moneda:"/>
			<mx:ComboBox id="cboMoneda" tabIndex="3" x="138" y="74" width="153" labelField="nombre"/>
			<mx:Label id="lblMonedaExt" x="32" y="108" text="Moneda Extranjera:"/>
			<mx:ComboBox id="cboMonedaExt" tabIndex="4" x="138" y="105" width="153" labelField="nombre"/>
			<mx:Label id="lblNumTransac" x="10" y="44" text="Número Transacciones:"/>
			<mx:TextInput id="txtNumTransac" tabIndex="2" x="138" y="42" width="35"/>
			<mx:Label id="lblEmailCump" x="15" y="170" text="Email Of. Cumplimiento:"/>
			<mx:TextInput id="txtEmailCump" tabIndex="6" x="138" y="169" width="230.5"/>
		</mx:Canvas>
		<mx:Button id="btnGuardar"  tabIndex="7" x="331.5" y="252" click="guardarParametros()" label="Guardar"/>
	</mx:Canvas>
</mx:Canvas>